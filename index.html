<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>RuraX | Elite Financial Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold-primary: #D4AF37; 
            --dark-bg: #0A0A0B;
            --border-gold: rgba(212, 175, 55, 0.15);
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            box-sizing: border-box;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--dark-bg); 
            color: #E2E2E2; 
            margin: 0;
            padding: 0;
            overflow: hidden; 
            height: 100dvh;
            width: 100vw;
            display: flex;
            justify-content: center;
        }

        #app-wrapper {
            width: 100%;
            max-width: 450px;
            height: 100%;
            background: var(--dark-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
            overflow: hidden;
        }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 120px; 
        }

        .scroll-area::-webkit-scrollbar { display: none; }

        .font-serif { font-family: 'Cinzel', serif; }
        .gold-text { background: linear-gradient(135deg, #FDE68A 0%, #D4AF37 50%, #B48924 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .premium-card { 
            background: linear-gradient(145deg, rgba(30, 30, 35, 0.6) 0%, rgba(10, 10, 12, 0.8) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-gold);
        }

        .btn-premium { 
            background: linear-gradient(to right, #B48924, #D4AF37, #F9E498);
            color: #000;
            font-weight: 700;
            transition: transform 0.2s active;
        }
        .btn-premium:active { transform: scale(0.96); }

        .glass-nav { 
            background: rgba(10, 10, 11, 0.85); 
            backdrop-filter: blur(25px); 
            border-top: 1px solid rgba(255,255,255,0.08); 
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-fixed {
            background: rgba(10, 10, 11, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
        }

        .input-premium { 
            background: rgba(255,255,255,0.05) !important; 
            border: 1px solid rgba(255,255,255,0.1) !important; 
            color: white !important;
            outline: none !important;
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="init-loader" class="fixed inset-0 z-[1000] bg-[#0A0A0B] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-2 border-amber-500/20 border-t-amber-500 rounded-full animate-spin mb-4"></div>
        <h2 class="font-serif gold-text text-lg tracking-[0.4em] font-bold">RURAX</h2>
    </div>

    <div id="app-wrapper">
        
        <section id="view-auth" class="hidden absolute inset-0 z-[200] bg-[#0A0A0B] flex flex-col justify-center px-8 fade-in">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-serif gold-text tracking-tighter">RuraX</h1>
                <p class="text-[9px] uppercase tracking-[0.4em] text-slate-500 mt-2">The Private Elite Ledger</p>
            </div>
            <div class="premium-card p-8 rounded-[2.5rem]">
                <h2 id="auth-header" class="text-xl font-bold mb-6 text-center text-white/90">Authorized Access</h2>
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="user-email" required class="input-premium w-full p-4 rounded-2xl text-sm" placeholder="Email Address">
                    <input type="password" id="user-pass" required class="input-premium w-full p-4 rounded-2xl text-sm" placeholder="Security Key">
                    <div id="auth-err-msg" class="hidden text-[10px] text-rose-400 text-center font-bold"></div>
                    <button type="submit" id="auth-submit-btn" class="w-full py-4 btn-premium rounded-2xl uppercase tracking-widest text-[10px]">Verify Identity</button>
                </form>
                <button id="auth-mode-toggle" class="w-full mt-6 text-[10px] text-slate-500 uppercase tracking-widest">New? Register Here</button>
            </div>
        </section>

        <section id="view-dashboard" class="hidden h-full flex flex-col fade-in">
            <header class="header-fixed p-6 pt-10 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-serif gold-text tracking-widest">RuraX</h1>
                    <p id="nav-user-id" class="text-[8px] text-slate-500 uppercase font-black mt-0.5">SECURE_SESSION</p>
                </div>
                <button onclick="triggerLogout()" class="w-10 h-10 bg-white/5 rounded-xl border border-white/10 flex items-center justify-center text-amber-500/80">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </header>

            <div class="scroll-area p-6">
                <div class="premium-card p-8 rounded-[2.5rem] mb-8 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 font-serif text-4xl">RX</div>
                    <p class="text-[9px] text-amber-500/50 uppercase tracking-[0.2em] font-black mb-1">Total Net Worth</p>
                    <h2 id="val-net" class="text-4xl font-bold tracking-tighter">₹ 0</h2>
                    <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-white/5">
                        <div>
                            <p class="text-[7px] text-slate-500 uppercase font-black mb-0.5">Capital In</p>
                            <p id="val-get" class="text-emerald-400 font-bold text-base">₹ 0</p>
                        </div>
                        <div>
                            <p class="text-[7px] text-slate-500 uppercase font-black mb-0.5">Capital Out</p>
                            <p id="val-give" class="text-rose-400 font-bold text-base">₹ 0</p>
                        </div>
                    </div>
                </div>

                <h3 class="text-[10px] font-black text-amber-500/30 uppercase tracking-[0.4em] mb-4 px-2">Managed Clients</h3>
                <div id="clients-container" class="space-y-4"></div>
            </div>

            <nav class="glass-nav p-6 pb-8">
                <button onclick="openModal('modal-add-client')" class="btn-premium w-full py-4 rounded-2xl uppercase tracking-widest text-[10px] shadow-lg">New Entry</button>
            </nav>
        </section>

        <section id="view-ledger" class="hidden h-full flex flex-col fade-in">
            <header class="header-fixed p-6 pt-10 flex items-center gap-4">
                <button onclick="navigateTo('view-dashboard')" class="w-10 h-10 bg-white/5 rounded-xl border border-white/10 flex items-center justify-center">
                    <svg width="20" height="20" fill="none" stroke="#D4AF37" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div>
                    <h2 id="active-client-title" class="font-bold text-lg leading-tight">Client Name</h2>
                    <p id="active-client-sub" class="text-[8px] text-amber-500/50 uppercase font-black tracking-widest">Active Ledger</p>
                </div>
            </header>

            <div id="transactions-container" class="scroll-area p-6 space-y-3"></div>

            <nav class="glass-nav p-6 pb-8 flex gap-3">
                <button onclick="initTxFlow('GIVE')" class="flex-1 bg-rose-500/10 text-rose-500 border border-rose-500/20 py-4 rounded-2xl font-black text-[9px] tracking-widest uppercase">GAVE</button>
                <button onclick="initTxFlow('GET')" class="flex-1 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 py-4 rounded-2xl font-black text-[9px] tracking-widest uppercase">GOT</button>
            </nav>
        </section>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[500] hidden bg-black/90 backdrop-blur-md items-end sm:items-center justify-center p-6">
        <div class="absolute inset-0" onclick="closeActiveModals()"></div>
        
        <div id="modal-add-client" class="relative z-[510] w-full max-w-sm premium-card rounded-[2.5rem] p-8 hidden fade-in">
            <h3 class="text-center font-serif gold-text mb-6 tracking-widest uppercase">Client Registration</h3>
            <form onsubmit="handleClientCreation(event)" class="space-y-4">
                <input type="text" id="inp-c-name" required placeholder="Legal Name" class="input-premium w-full p-4 rounded-2xl text-sm">
                <input type="tel" id="inp-c-phone" required placeholder="Mobile Number" class="input-premium w-full p-4 rounded-2xl text-sm">
                <button type="submit" class="w-full btn-premium py-4 rounded-2xl text-[10px] tracking-widest uppercase">Register</button>
            </form>
        </div>

        <div id="modal-tx-entry" class="relative z-[510] w-full max-w-sm premium-card rounded-[2.5rem] p-8 hidden fade-in text-center">
            <p id="tx-entry-title" class="text-[9px] font-black text-amber-500/40 uppercase mb-6 tracking-widest">Authorization</p>
            <input type="number" id="inp-tx-amount" required placeholder="0.00" class="bg-transparent text-5xl font-black w-full text-center outline-none text-white mb-6 border-b border-white/5 pb-2">
            <input type="text" id="inp-tx-note" placeholder="Particulars / Reason" class="input-premium w-full p-4 rounded-2xl text-sm text-center mb-6">
            <div class="flex gap-3">
                <button type="button" onclick="closeActiveModals()" class="flex-1 text-slate-500 font-bold text-[9px] uppercase tracking-widest">Cancel</button>
                <button id="btn-tx-confirm" class="flex-1 btn-premium py-4 rounded-2xl text-[9px] tracking-widest uppercase">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBUCZ42OzkKjJgwTYLA-LY2fj6KtViSBBs",
          authDomain: "khata-41719.firebaseapp.com",
          databaseURL: "https://khata-41719-default-rtdb.firebaseio.com",
          projectId: "khata-41719",
          storageBucket: "khata-41719.firebasestorage.app",
          messagingSenderId: "197866577320",
          appId: "1:197866577320:web:e6b0208809fd251d51d19d",
          measurementId: "G-HGKKV96P6V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let activeUser = null;
        let authState = 'signin';
        let clientsCache = [];
        let currentActiveClientId = null;

        onAuthStateChanged(auth, (user) => {
            activeUser = user;
            document.getElementById('init-loader').style.display = 'none';
            if (user) {
                document.getElementById('nav-user-id').innerText = `ID: ${user.email.split('@')[0].toUpperCase()}`;
                navigateTo('view-dashboard');
                initDataSync();
            } else {
                navigateTo('view-auth');
            }
        });

        window.navigateTo = (id) => {
            const views = ['view-auth', 'view-dashboard', 'view-ledger'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if (id === 'view-dashboard') currentActiveClientId = null;
        };

        document.getElementById('auth-mode-toggle').onclick = () => {
            authState = (authState === 'signin') ? 'signup' : 'signin';
            document.getElementById('auth-header').innerText = (authState === 'signin') ? 'Authorized Access' : 'Establish ID';
            document.getElementById('auth-submit-btn').innerText = (authState === 'signin') ? 'Verify Identity' : 'Register ID';
            document.getElementById('auth-mode-toggle').innerText = (authState === 'signin') ? 'New? Register Here' : 'Already Member? Login';
        };

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-pass').value;
            const btn = document.getElementById('auth-submit-btn');
            const err = document.getElementById('auth-err-msg');
            btn.disabled = true; btn.innerText = "AUTHENTICATING...";
            try {
                if (authState === 'signin') await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (e) { err.innerText = e.message; err.classList.remove('hidden'); }
            finally { btn.disabled = false; btn.innerText = (authState === 'signin') ? 'Verify Identity' : 'Register ID'; }
        };

        window.triggerLogout = () => signOut(auth);

        function initDataSync() {
            if (!activeUser) return;
            onValue(ref(db, `users/${activeUser.uid}/clients`), (snap) => {
                const data = snap.val();
                clientsCache = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                updateDashboardUI();
                if (currentActiveClientId) updateLedgerUI();
            });
        }

        function updateDashboardUI() {
            const container = document.getElementById('clients-container');
            let rec = 0, pay = 0;
            container.innerHTML = clientsCache.length ? '' : '<div class="text-center py-20 opacity-10 uppercase text-[10px] font-black">No Records Found</div>';
            clientsCache.forEach(c => {
                const bal = c.balance || 0;
                if (bal >= 0) rec += bal; else pay += Math.abs(bal);
                const card = document.createElement('div');
                card.className = "premium-card p-5 rounded-3xl flex justify-between items-center active:bg-white/5 transition-colors cursor-pointer";
                card.onclick = () => { currentActiveClientId = c.id; navigateTo('view-ledger'); updateLedgerUI(); };
                
                // Show Mobile Number if exists
                const displayPhone = c.phone ? c.phone : 'No Number';

                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-amber-500/5 border border-amber-500/20 rounded-2xl flex items-center justify-center font-serif text-amber-500 font-bold">${c.name.charAt(0)}</div>
                        <div>
                            <h4 class="font-bold text-sm text-white/90">${c.name}</h4>
                            <p class="text-[8px] text-amber-500/60 font-medium tracking-widest mt-0.5">${displayPhone}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm ${bal >= 0 ? 'text-emerald-400' : 'text-rose-400'}">₹${Math.abs(bal).toLocaleString('en-IN')}</p>
                    </div>`;
                container.appendChild(card);
            });
            document.getElementById('val-net').innerText = `₹${(rec - pay).toLocaleString('en-IN')}`;
            document.getElementById('val-get').innerText = `₹${rec.toLocaleString('en-IN')}`;
            document.getElementById('val-give').innerText = `₹${pay.toLocaleString('en-IN')}`;
        }

        function updateLedgerUI() {
            const client = clientsCache.find(cl => cl.id === currentActiveClientId);
            if (!client) return;
            document.getElementById('active-client-title').innerText = client.name;
            const container = document.getElementById('transactions-container');
            const txs = client.transactions ? Object.values(client.transactions).sort((a,b) => b.time - a.time) : [];
            container.innerHTML = txs.length ? '' : '<div class="text-center py-10 opacity-10 text-[10px] uppercase font-bold">No History</div>';
            txs.forEach(t => {
                const row = document.createElement('div');
                row.className = "premium-card p-4 rounded-2xl flex justify-between items-center border-l-4 " + (t.type === 'GET' ? 'border-emerald-500/50' : 'border-rose-500/50');
                row.innerHTML = `<div><p class="text-[8px] text-slate-600 font-bold uppercase mb-1">${t.date}</p><p class="text-[11px] text-white/70">${t.note}</p></div>
                    <p class="font-black text-sm ${t.type === 'GET' ? 'text-emerald-400' : 'text-rose-400'}">${t.type === 'GET' ? '+' : '-'} ₹${t.amount.toLocaleString('en-IN')}</p>`;
                container.appendChild(row);
            });
        }

        window.openModal = (id) => { 
            document.getElementById('modal-overlay').classList.remove('hidden'); 
            document.getElementById('modal-overlay').classList.add('flex'); 
            document.getElementById(id).classList.remove('hidden'); 
        };
        window.closeActiveModals = () => { 
            document.getElementById('modal-overlay').classList.add('hidden'); 
            document.getElementById('modal-add-client').classList.add('hidden'); 
            document.getElementById('modal-tx-entry').classList.add('hidden'); 
        };

        window.handleClientCreation = async (e) => {
            e.preventDefault();
            const name = document.getElementById('inp-c-name').value;
            const phone = document.getElementById('inp-c-phone').value;
            if(!name) return;
            await push(ref(db, `users/${activeUser.uid}/clients`), { name, phone, balance: 0, time: Date.now() });
            closeActiveModals(); e.target.reset();
        };

        window.initTxFlow = (type) => {
            document.getElementById('tx-entry-title').innerText = (type === 'GET') ? 'CREDIT AUTHORIZATION' : 'DEBIT AUTHORIZATION';
            document.getElementById('inp-tx-amount').value = '';
            document.getElementById('inp-tx-note').value = '';
            document.getElementById('btn-tx-confirm').onclick = () => authorizeTransaction(type);
            openModal('modal-tx-entry');
        };

        async function authorizeTransaction(type) {
            const amount = parseFloat(document.getElementById('inp-tx-amount').value);
            const note = document.getElementById('inp-tx-note').value || 'Auth Entry';
            if (!amount || !currentActiveClientId) return;
            const client = clientsCache.find(c => c.id === currentActiveClientId);
            const dateStr = new Date().toLocaleString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            await push(ref(db, `users/${activeUser.uid}/clients/${currentActiveClientId}/transactions`), { amount, type, note, date: dateStr, time: Date.now() });
            const newBal = (type === 'GET') ? (client.balance || 0) + amount : (client.balance || 0) - amount;
            await update(ref(db, `users/${activeUser.uid}/clients/${currentActiveClientId}`), { balance: newBal });
            closeActiveModals();
        }
    </script>
</body>
</html>

